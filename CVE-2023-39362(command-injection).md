### CVE-2021-21315

1 Tổng quan lỗ hổng

- CVE ID: CVE-2023-39362

- Thành phần ảnh hưởng: Cacti – chức năng quản lý Device (SNMP Options)

- Phiên bản bị ảnh hưởng: Cacti 1.2.24

- Loại lỗ hổng: Authenticated Command Injection

- Mô tả: Trong phiên bản Cacti 1.2.24, tồn tại một lỗ hổng bảo mật cho phép người dùng đã được xác thực và có quyền quản lý thiết bị thực hiện tấn công chèn lệnh hệ điều hành (Command Injection).

- Nguyên nhân của lỗ hổng xuất phát từ việc giá trị do người dùng kiểm soát trong phần cấu hình SNMP của Device (ví dụ: SNMP Community String) không được kiểm tra và lọc đầu vào một cách an toàn trước khi được đưa vào các lệnh hệ thống liên quan đến SNMP. Điều này cho phép kẻ tấn công chèn các chuỗi lệnh độc hại, dẫn đến việc thực thi lệnh tùy ý trên máy chủ chạy Cacti với quyền của tiến trình dịch vụ.

- Việc khai thác lỗ hổng không yêu cầu tương tác trực tiếp với đầu ra của lệnh, do đó được phân loại là Blind Command Injection. Tuy nhiên, kẻ tấn công vẫn có thể xác nhận việc khai thác thành công thông qua các tác động phụ (side effects) như tạo tệp tin trên hệ thống hoặc thiết lập kết nối mạng ra bên ngoài.

2 Build Lab

- Môi trường lab được triển khai bằng Docker

- Các bước build lab

1. Sử dụng docker compose up -d

2. Truy cập Cacti: Mở trình duyệt tại http://127.0.0.1/cacti

3. Thực hiện wizard cài đặt Cacti. Chọn các tùy chọn mặc định

<img width="1022" height="559" alt="image" src="https://github.com/user-attachments/assets/d34542f2-898f-4998-9fe6-3b76cb86cf8c" />

4. Đăng nhập với tài khoản mặc định: admin / admin

5. Chuẩn bị tài khoản user để thực hiện demo exploit: Vào Console → Configuration → Users -> Kích hoạt user guest -> Đặt mật khẩu

<img width="1579" height="693" alt="image" src="https://github.com/user-attachments/assets/584b7b6b-516b-417a-93ad-85709534d399" />

6. Gán quyền: Console Access và Sites / Devices / Data

<img width="1711" height="448" alt="image" src="https://github.com/user-attachments/assets/b698486e-9d3e-41a2-9f62-5d55af7dae49" />

Đăng xuất admin và đăng nhập lại bằng user guest

Kết quả:
User guest có đủ quyền để cấu hình Device và SNMP — đúng điều kiện khai thác CVE.

3. Demo khai thác

- Manual

B1: Vào Console → Create → New Device

B2: Tạo Device hỗ trợ SNMP v1 hoặc v2

B3: Gắn 1 Graph Template yêu cầu SNMP bất kì, ví dụ:

Net‑SNMP – Combined SCSI Disk Bytes

Net‑SNMP – Combined SCSI Disk I/O

B4: Trong SNMP Options → SNMP Community String:

Nhập chuỗi chứa payload command injection: public\' ; touch /tmp/test ; \'

B5: Tạo Device

<img width="1674" height="892" alt="image" src="https://github.com/user-attachments/assets/f59c455a-556f-43f0-98b1-07fea566a3bb" />

Khi Cacti thực hiện polling SNMP, payload sẽ được thực thi trên server.

Dấu hiệu thành công:

File test được tạo trên hệ thống

<img width="690" height="68" alt="image" src="https://github.com/user-attachments/assets/c6d91c30-80c9-4c1d-b78b-2ad200894e6b" />

- Demo bằng tool

Script Python trong repo tự động hóa toàn bộ quá trình khai thác:

Đăng nhập vào Cacti

Tạo Device

Chèn payload vào SNMP options

Kích hoạt command injection

<img width="1067" height="127" alt="image" src="https://github.com/user-attachments/assets/92ffeaf2-4a80-4aaf-ae55-3901e9a21ec9" />

4 Phân tích lỗ hổng (Analysis)

- Nguyên nhân: Lỗ hổng CVE-2023-39362 xuất phát từ việc Cacti không kiểm tra và xử lý an toàn dữ liệu đầu vào do người dùng kiểm soát trong quá trình cấu hình Device, cụ thể là tại các trường liên quan đến SNMP Options (ví dụ: SNMP Community String). Trong Cacti 1.2.24, giá trị của các trường SNMP này được: Nhận trực tiếp từ giao diện web, lưu vào cấu hình Device sau đó được ghép chuỗi (string concatenation) vào các lệnh hệ thống dùng để thực hiện SNMP polling (thông qua snmpget/snmpwalk hoặc spine). Quá trình này không thực hiện các biện pháp bảo vệ cần thiết, bao gồm: không escape các ký tự shell đặc biệt (;, ', ", |, &, …), không giới hạn whitelist ký tự hợp lệ, không tách biệt rõ ràng giữa dữ liệu và lệnh hệ thống. Do đó, attacker có thể chèn thêm các chuỗi lệnh tùy ý vào giá trị SNMP, dẫn đến Command Injection ở mức hệ điều hành.

- Lỗ hổng được phân loại là Blind Command Injection vì: Output của lệnh hệ điều hành không được trả về trực tiếp trong HTTP response, giao diện web không hiển thị kết quả thực thi lệnh. Tuy nhiên, attacker vẫn có thể xác nhận việc khai thác thành công thông qua các tác động phụ (side effects) như tạo file trên hệ thống (/tmp/test)
