### SQL Injection trong plugin Depicter Slider & Popup Builder (< 3.6.2)

1 Tổng quan lỗ hổng

- CVE-ID: CVE-2025-2011

- Loại lỗ hổng: SQL Injection

- Phần mềm bị ảnh hưởng: Plugin WordPress Depicter – Slider & Popup Builder, phiên bản < 3.6.2

- Môi trường: WordPress

- Điều kiện khai thác: Không yêu cầu quyền quản trị (tùy endpoint), tấn công thông qua HTTP request.

- Tác động: Trích xuất dữ liệu cơ sở dữ liệu, lộ thông tin tài khoản quản trị.

2 Build Lab – Thiết lập môi trường thử nghiệm

- Khởi động docker desktop

<img width="1333" height="392" alt="image" src="https://github.com/user-attachments/assets/75151cfb-869d-490b-9b4a-addb1be368a3" />

- Khởi động môi trường bằng lệnh: `docker-compose up -d`

<img width="454" height="215" alt="image" src="https://github.com/user-attachments/assets/99d8c64a-ed56-4677-9a57-42abff073dd0" />

- Cài đặt WordPress, truy cập: http://localhost:5555 để thực hiện: Chọn ngôn ngữ, thiết lập tiêu đề website, tạo tài khoản quản trị viên.

<img width="1120" height="623" alt="image" src="https://github.com/user-attachments/assets/d960e0ce-d0e4-46b8-971b-729633944da6" />

<img width="577" height="428" alt="image" src="https://github.com/user-attachments/assets/7e7cd167-e584-4dec-bcd3-3c7725e848dc" />

- Cài đặt plugin dễ bị tổn thương trong wordpress

B1. Chạy lệnh: `docker exec -it cve-2025-2011-main-wordpress-1 bash`

<img width="627" height="44" alt="image" src="https://github.com/user-attachments/assets/cecc8e85-74a4-4110-8deb-e52751f2bb95" />

B2. Cài WP-CLI

`curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar`

`chmod +x wp-cli.phar`

`mv wp-cli.phar /usr/local/bin/wp`

<img width="828" height="697" alt="image" src="https://github.com/user-attachments/assets/580d0251-1f0a-4afe-89d3-8e9c449fbe6c" />

Tải và cài Depicter v3.6.1

`wp plugin install depicter --version=3.6.1 --activate --allow-root`

<img width="732" height="325" alt="image" src="https://github.com/user-attachments/assets/56b3bf5b-6a9c-4d72-8104-7d93d6217790" />

4 Demo exploit(tool và manual)
- manual:

B1. Xác định AJAX gateway công khai của WordPress

Truy cập endpoint:

http://localhost:5555/wp-admin/admin-ajax.php

Trong WordPress, admin-ajax.php là AJAX gateway trung tâm, được thiết kế để xử lý các yêu cầu AJAX cho cả người dùng đã đăng nhập và chưa đăng nhập.
Các plugin khi muốn expose chức năng AJAX đều phải đăng ký action thông qua endpoint này.

Send request to repeater.

<img width="658" height="319" alt="image" src="https://github.com/user-attachments/assets/7f49d635-4be2-4287-879b-d8fe38c95613" />

B2. Xác định action do plugin Depicter expose

Plugin Depicter Slider & Popup Builder đăng ký action:

depicter-lead-index

Action này được expose thông qua hook wp_ajax_nopriv_depicter-lead-index, cho phép truy cập không cần xác thực.

Tiến hành gửi request với tham số action tương ứng:

`GET /wp-admin/admin-ajax.php?action=depicter-lead-index HTTP/1.1`

<img width="792" height="462" alt="image" src="https://github.com/user-attachments/assets/34c778a4-7373-4734-82c5-74b73f8b126f" />

Response trả về dữ liệu JSON hợp lệ, xác nhận rằng: Endpoint tồn tại, Action được xử lý bởi plugin, Không yêu cầu đăng nhập.

B3. Xác định tham số đầu vào nghi vấn (s)

Trong quá trình xử lý action depicter-lead-index, plugin sử dụng tham số s để tìm kiếm (search/filter) dữ liệu leads. Tham số này được truyền trực tiếp vào câu truy vấn SQL dạng LIKE '%<input>%' mà không được sanitize hoặc prepared.

Tiến hành thêm tham số s vào request:

`GET /wp-admin/admin-ajax.php?action=depicter-lead-index&s=test HTTP/1.1`

<img width="851" height="473" alt="image" src="https://github.com/user-attachments/assets/8113d932-bdd0-46c0-8ba5-ab4434b2df4f" />

Response trả về bình thường, xác nhận tham số s được xử lý phía server.

Bước 4: Thực hiện kiểm tra SQL Injection (Boolean-based)

Tiến hành chèn payload boolean-based để kiểm tra khả năng injection:

`s=test' AND 1=1`

Request hoàn chỉnh:

`GET /wp-admin/admin-ajax.php?action=depicter-lead-index&s=test%27%20AND%201=1 HTTP/1.1`

<img width="1521" height="781" alt="image" src="https://github.com/user-attachments/assets/60c47735-1b37-46cd-ac7e-00cf84877a93" />

Response trả về lỗi cơ sở dữ liệu WordPress (wpdb error), trong đó hiển thị trực tiếp câu SQL được thực thi.

Điều này chứng minh rằng: Dữ liệu đầu vào không được escape, payload đã phá vỡ cú pháp SQL, truy vấn SQL bị kiểm soát bởi attacker.

B5: Dump database

<img width="1115" height="514" alt="image" src="https://github.com/user-attachments/assets/b7703591-0b12-43ef-b1d2-9a82ec225844" />

- tools:
B1. Chạy lệnh: `python poc.py -u http://localhost:5555` để xác minh có phải phiên bản chứa lỗ hổng không.

<img width="597" height="238" alt="image" src="https://github.com/user-attachments/assets/178cf30b-44d9-4ba0-8ca3-315129e7961c" />

B2. Trích xuất thông tin admin: `python poc.py -u http://localhost:5555 -m admin`

<img width="703" height="299" alt="image" src="https://github.com/user-attachments/assets/4fa86e6f-3aa5-4663-bb82-139bbd4acc23" />

5 Phân tích

- Lỗ hổng SQL Injection xảy ra trong hàm xử lý AJAX action depicter-lead-index của plugin Depicter, cụ thể là đoạn code backend xử lý tham số tìm kiếm s và xây dựng câu truy vấn SQL.

- Vị trí logic gây lỗi:

1. File: thuộc plugin Depicter Slider & Popup Builder

2. Ngữ cảnh: hàm được đăng ký qua hook: add_action('wp_ajax_nopriv_depicter-lead-index', ...);

3. Endpoint thực tế: /wp-admin/admin-ajax.php?action=depicter-lead-index

- Trong hàm xử lý này, plugin: Lấy trực tiếp tham số s từ request: `$s = $_GET['s'];`, sử dụng tham số s để xây dựng truy vấn SQL tìm kiếm dữ liệu leads. Ghép chuỗi SQL thủ công, dạng: `... WHERE column LIKE '%$s%'`. Thực thi truy vấn bằng $wpdb->get_results() mà không dùng $wpdb->prepare()

- Plugin Depicter cung cấp các endpoint AJAX / REST để: Lấy dữ liệu slider, truy vấn cấu hình popup, xử lý tham số động từ client: không được sanitize, không sử dụng prepared statements.

- Nguyên nhân

1. Không kiểm soát đầu vào (Input Validation). Tham số s lấy trực tiếp từ request ($_GET['s']), không có bước: sanitize_text_field(), esc_sql() hoặc bất kỳ validation nào khác. Điều này cho phép attacker truyền vào payload SQL hoàn chỉnh.

2. Không sử dụng Prepared Statements, plugin không sử dụng các cơ chế an toàn sẵn có của WordPress: $wpdb->prepare(), Placeholder (%s, %d). Thay vào đó, plugin nối chuỗi SQL thủ công, đây là anti-pattern kinh điển gây SQL Injection.

3. Expose endpoint không yêu cầu xác thực, action depicter-lead-index được đăng ký thông qua: add_action('wp_ajax_nopriv_depicter-lead-index', ...); Endpoint có thể truy cập từ Internet không yêu cầu: Đăng nhập, Nonce, Capability check (current_user_can()). Điều này biến lỗi SQLi thành unauthenticated SQL Injection, mức độ nguy hiểm rất cao.

4. Hiển thị lỗi SQL trực tiếp (Information Disclosure), trong môi trường debug (hoặc cấu hình chưa chặt chẽ), WordPress trả về: Lỗi wpdb, câu SQL hoàn chỉnh, thông báo lỗi MySQL (XPATH syntax error, You have an error in your SQL syntax…). Điều này giúp attacker xác nhận lỗ hổng, khai thác dễ dàng hơn (error-based SQLi), Trích xuất dữ liệu nhanh chóng.
