## Stored XSS dẫn tới XSS‑assisted CSRF trong Gitea (CVE‑2021‑28378)

1 Tổng quan

- CVE ID: CVE‑2021‑28378

- Thành phần ảnh hưởng: Gitea – chức năng hiển thị ref‑issue popup (issue tooltip)

- Phiên bản bị ảnh hưởng: Gitea ≤ 1.12.5

- Loại lỗ hổng: Stored Cross‑Site Scripting (XSS) → dẫn tới XSS‑assisted CSRF

- Mô tả: Trong các phiên bản Gitea bị ảnh hưởng, tồn tại một lỗ hổng Stored XSS tại cơ chế hiển thị ref‑issue popup (tooltip hiển thị khi người dùng di chuột vào link issue đầy đủ URL).

- Các trường dữ liệu do người dùng kiểm soát, bao gồm: label.name, issue.title, issue.body được lưu trữ trong cơ sở dữ liệu và sau đó được render trực tiếp vào DOM của popup bằng JavaScript mà không được escape hoặc sanitize an toàn.Khi một người dùng đã đăng nhập (nạn nhân) chỉ cần di chuột (hover) vào link issue, payload JavaScript được thực thi trong context cùng origin, với quyền của phiên làm việc hiện tại. Việc thực thi JavaScript này cho phép kẻ tấn công truy cập và đánh cắp CSRF token (_csrf) được nhúng trong DOM, từ đó thực hiện các hành động authenticated thông qua các request hợp lệ.

2 Build Lab

- Triển khai lab bằng Docker

- Sử dụng image Gitea vulnerable:

```
version: "3"

services:
  gitea:
    image: gitea/gitea:1.12.4
    container_name: gitea_cve_2021_28378
    ports:
      - "3000:3000"
      - "2222:22"
    volumes:
      - ./data:/data
```
- Chạy lab: `docker compose up -d`

- Truy cập Gitea tại: http://localhost:3000

<img width="1578" height="926" alt="image" src="https://github.com/user-attachments/assets/9dd71f04-fe80-449d-bd56-6b7b49b692c6" />

Khởi tạo hệ thống: Database: SQLite3; Cài đặt mặc định

<img width="998" height="946" alt="image" src="https://github.com/user-attachments/assets/70fecd42-0442-4d24-8845-6d068fbb2830" />

- Tạo tài khoản: Username: attacker; Password: @Dmin123 → Tài khoản này dùng để chuẩn bị payload Stored XSS

<img width="776" height="393" alt="image" src="https://github.com/user-attachments/assets/8cee10af-da4a-4ba9-ac7c-78ccaa3c674d" />

<img width="846" height="416" alt="image" src="https://github.com/user-attachments/assets/d8d3f0f9-73cc-4cfd-ae48-88f34a21c865" />

3 Demo khai thác

B1: Chuẩn bị payload XSS(Tạo label chứa XSS):

<img width="862" height="176" alt="image" src="https://github.com/user-attachments/assets/098c1f91-65c5-476d-a01e-2ddcf3597d54" />

<img width="796" height="953" alt="image" src="https://github.com/user-attachments/assets/3869442d-59c7-42a9-a9dd-8264a8191177" />

<img width="311" height="349" alt="image" src="https://github.com/user-attachments/assets/1e49988b-5d37-4d63-8a5f-bddf215dfa97" />

<img width="1058" height="415" alt="image" src="https://github.com/user-attachments/assets/91a7502a-74a4-4984-9305-4281c8943bb8" />

- Tạo label name: `<script>alert('CVE-2021-28378')</script>`

<img width="992" height="143" alt="image" src="https://github.com/user-attachments/assets/80799c46-7979-4071-93e0-8e12ac65529d" />

- Tạo issue với title `<img src=x onerror=alert('title')>` và body với nội dung `<script>alert('body')</script>`, sau đó gắn label tạo ở bước trước

<img width="1008" height="597" alt="image" src="https://github.com/user-attachments/assets/a9c9ffc1-903a-46e6-90ae-149a75cc7a13" />

<img width="990" height="863" alt="image" src="https://github.com/user-attachments/assets/c46df7ac-207f-4622-a403-a8a200f36e07" />

- Tạo issue thứ hai với title bất kì và body với nội dung `http://localhost:3000/attacker/evil/issues/1`

<img width="934" height="671" alt="image" src="https://github.com/user-attachments/assets/c6809da0-75c9-4db6-9b80-f0016edea24b" />

- Sau khi di chuột vào link issue #1:

<img width="1090" height="867" alt="image" src="https://github.com/user-attachments/assets/214c6caf-00cb-400c-bcf8-7fc0f26121a6" />

B2: Khai thác CSRF token

- Trong repo evil tạo file exploit.js

<img width="1291" height="815" alt="image" src="https://github.com/user-attachments/assets/3ceceb03-7277-47b9-9ede-76813c4c6b23" />

<img width="1242" height="570" alt="image" src="https://github.com/user-attachments/assets/2500bbfc-6abe-4ad8-8c2f-e2a5607b39a7" />

- Sửa lại body trong issue #1 thành `<script src="http://localhost:3000/attacker/evil/raw/branch/master/exploit.js"></script>`

<img width="1358" height="639" alt="image" src="https://github.com/user-attachments/assets/f60e05bb-d334-429f-8cf2-3910b9cd0598" />

- Sau khi di chuột vào link issue #1:

<img width="1302" height="701" alt="image" src="https://github.com/user-attachments/assets/9b4c5e39-dcc7-448e-9f9f-49d0a8b63959" />

4 Phân tích

- Nguyên nhân: Lỗ hổng CVE‑2021‑28378 xuất phát từ việc Gitea không xử lý an toàn dữ liệu đầu vào do người dùng kiểm soát trong quá trình hiển thị ref‑issue popup. Dữ liệu từ issue.title, issue.body, label.name: Được nhập qua giao diện web, lưu trữ trong database, được load lại bằng AJAX khi hiển thị tooltip, nội dung được chèn trực tiếp vào DOM bằng innerHTML.

- Không áp dụng: HTML escaping, Output encoding, Sanitization whitelist. Do đó, attacker có thể chèn mã JavaScript tùy ý, dẫn đến Stored XSS.

- CSRF token _csrf tồn tại và hoạt động đúng, token được nhúng trong DOM (<meta>), JavaScript chạy trong same‑origin context, attacker đọc token và gửi request hợp lệ -> XSS‑assisted CSRF

- Việc kết hợp XSS với CSRF token hợp lệ dẫn tới XSS‑assisted CSRF, cho phép thực hiện các hành động nhạy cảm mà không cần bypass cơ chế bảo vệ CSRF.
